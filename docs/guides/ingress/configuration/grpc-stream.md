---
title: Enable HTTP/2
menu:
  product_voyager_8.0.1:
    identifier: enable-http-2
    name: Enable HTTP/2
    parent: Enable HTTP/2
    weight: 10
product_name: voyager
menu_name: product_voyager_8.0.1
section_menu_id: guides
---
> New to Voyager? Please start [here](/docs/concepts/overview.md).

# Enable HTTP/2

You can configure HTTP/2.0 by configuring `proto` or, `alpn` under `rules.http` section (for frontend) or, `backend` section (for specific backend). If you want to use only `HTTP/2.0`, then you can specify it using `proto: h2`. However, if you like to use both `HTTP/2.0` and `HTTP/1.1` in a preferred order, then you need to specify the order using `ALPN`.

Please note the followings:
- TLS needed to be configured for using `ALPN`.
- A single rule/backend can't use both `ALPN` and `proto`.
- Multiple rules pointing the same frontend can't use different `ALPN` or, `proto` configurations.

## Example: gRPC Stream

First create demo namespace for this example.

```
$ kubectl create namespace demo
namespace/demo created
```

### Deploy Test Server

Deploy a gRPC test server.

```yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    run: test-server
  name: test-server
  namespace: demo
spec:
  selector:
    matchLabels:
      run: test-server
  template:
    metadata:
      labels:
        run: test-server
    spec:
      containers:
      - image: diptadas/grpc-sample-server
        name: test-server
        imagePullPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  labels:
    run: test-server
  name: test-server
  namespace: demo
  annotations:
    ingress.appscode.com/backend-tls: ssl ca-file /tmp/ca/server.crt
spec:
  ports:
  - port: 3000
    targetPort: 3000
    name: grpc
  selector:
    run: test-server
```

Here, using `ingress.appscode.com/backend-tls` annotation we have specified the path of CA file. HAProxy will use this CA file to verify the backend server. So, we need to provide the CA file inside the haproxy-container in path `/tmp/ca/server.crt`. 

### Create Secret

Create secret for haproxy server.

```
$ kubectl create secret tls haproxy-secret -n demo --cert=sample/creds/haproxy.crt  --key=sample/creds/haproxy.key
```

Also, create another secret using the CA file of backend server.

```
$ kubectl create secret generic ca-secret -n demo --from-file=sample/creds/server.crt
```

### Create Ingress

Create the ingress and specify the secret of backend-server CA in `spec.configVolumes` and secret of haproxy TLS in `spec.tls`.

```yaml
apiVersion: voyager.appscode.com/v1beta1
kind: Ingress
metadata:
  name: test-ingress
  namespace: demo
  annotations:
    ingress.appscode.com/default-option: '{"http-server-close": "true", "dontlognull": "true", "http-use-htx": "true", "logasap": "true"}'
spec:
  tls:
  - secretName: haproxy-secret
    hosts:
    - "*"
  configVolumes:
  - name: ca-vol
    secret:
      secretName: ca-secret
    mountPath: /tmp/ca
  rules:
  - host: "*"
    http:
      alpn:
      - h2
      - http/1.1
      paths:
      - path: /
        backend:
          serviceName: test-server
          servicePort: 3000
          alpn:
          - h2
          - http/1.1
```

### Generated haproxy.cfg

```ini
# HAProxy configuration generated by https://github.com/appscode/voyager
# DO NOT EDIT!
global
  daemon
  stats socket /var/run/haproxy.sock level admin expose-fd listeners
  server-state-file global
  server-state-base /var/state/haproxy/
  # log using a syslog socket
  log /dev/log local0 info
  tune.ssl.default-dh-param 2048
  ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK
  lua-load /etc/auth-request.lua
defaults
  log global
  # https://cbonte.github.io/haproxy-dconv/1.7/configuration.html#4.2-option%20abortonclose
  # https://github.com/appscode/voyager/pull/403
  option dontlognull
  option http-server-close
  option http-use-htx
  option logasap
  # Timeout values
  timeout client 50s
  timeout client-fin 50s
  timeout connect 50s
  timeout server 50s
  timeout tunnel 50s
  # Configure error files
  # default traffic mode is http
  # mode is overwritten in case of tcp services
  mode http
frontend http-0_0_0_0-80
  bind *:80  
  mode http
  option httplog
  option forwardfor
  acl is_proxy_https hdr(X-Forwarded-Proto) https
  acl is_proxy_https ssl_fc
  http-request set-var(req.scheme) str(https) if is_proxy_https
  http-request set-var(req.scheme) str(http) if ! is_proxy_https
  acl acl_: path_beg /
  http-request set-var(req.redirect_to_ssl) req.hdr(host) if ! is_proxy_https  acl_:
  http-request replace-header Host ^(.*?):80+$ \1:443 if { var(req.redirect_to_ssl) -m found }
  http-request redirect scheme https code 308 if { var(req.redirect_to_ssl) -m found }
frontend http-0_0_0_0-443
  bind *:443  ssl no-sslv3 no-tlsv10 no-tls-tickets crt /etc/ssl/private/haproxy/tls/  alpn h2,http/1.1 
  # Mark all cookies as secure
  rsprep ^Set-Cookie:\ (.*) Set-Cookie:\ \1;\ Secure
  # Add the HSTS header with a 6 month default max-age
  http-response set-header Strict-Transport-Security max-age=15768000
  mode http
  option httplog
  option forwardfor
  acl is_proxy_https hdr(X-Forwarded-Proto) https
  acl is_proxy_https ssl_fc
  http-request set-var(req.scheme) str(https) if is_proxy_https
  http-request set-var(req.scheme) str(http) if ! is_proxy_https
  acl acl_: path_beg /
  use_backend test-server.demo:3000 if  acl_:
backend test-server.demo:3000
  server pod-test-server-84947f8d55-r7xv9 172.17.0.5:3000     ssl ca-file /tmp/ca/server.crt    alpn h2,http/1.1
```

### Check Response

```console
$ minikube service --url voyager-test-ingress -n demo
http://192.168.99.100:32277
http://192.168.99.100:30139
```

Run a gRPC client using docker.

```
$ docker run -it --env SERVER_ADDRESS=haproxy:32277 --env TLS_CERT=haproxy.crt --add-host=haproxy:192.168.99.100 diptadas/grpc-sample-client

Generating codenames...
2019/01/25 13:43:04 Received: Gallant Heron
2019/01/25 13:43:05 Received: Wicked Warthog
2019/01/25 13:43:06 Received: Quizzical Coyote
2019/01/25 13:43:07 Received: Artistic Shark
2019/01/25 13:43:08 Received: Lucid Vulture
```

You will see a stream of random names.

### Cleanup

```
$ kubectl delete ns demo
namespace "demo" deleted
```

